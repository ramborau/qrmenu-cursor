// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication (Better Auth integration)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  emailVerified Boolean @default(false) @map("email_verified")
  image     String?
  role      UserRole @default(OWNER)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Better Auth relations
  accounts  Account[]
  sessions  Session[]

  // App relations
  restaurants Restaurant[]

  @@map("users")
}

// Better Auth models
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String  @default("credential")
  provider          String  @default("credential")
  providerAccountId String  @default("") @map("provider_account_id")
  password          String? @db.Text  // Better Auth stores password here
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum UserRole {
  OWNER
  MANAGER
  STAFF
}

// Restaurant model
model Restaurant {
  id            String   @id @default(cuid())
  name          String
  ownerId       String   @map("owner_id")
  logoUrl       String?  @map("logo_url")
  heroImageUrl  String?  @map("hero_image_url")
  primaryColor  String?  @default("#075e54") @map("primary_color")
  secondaryColor String? @default("#00c307") @map("secondary_color")
  backgroundColor String? @default("#ffffff") @map("background_color")
  darkTheme     Boolean  @default(false) @map("dark_theme")
  typographySettings Json? @map("typography_settings")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  categories Category[]
  tables    Table[]
  dynamicPricing DynamicPricing[]
  offers    Offer[]

  @@map("restaurants")
}

// Category model
model Category {
  id          String   @id @default(cuid())
  restaurantId String  @map("restaurant_id")
  name        String
  description String?
  icon        String?
  showImages  Boolean  @default(true) @map("show_images")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant    Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  subCategories SubCategory[]

  @@unique([restaurantId, name])
  @@map("categories")
}

// SubCategory model
model SubCategory {
  id          String   @id @default(cuid())
  categoryId  String   @map("category_id")
  name        String
  description String?
  icon        String?
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  category   Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  menuItems MenuItem[]

  @@unique([categoryId, name])
  @@map("sub_categories")
}

// MenuItem model
model MenuItem {
  id              String            @id @default(cuid())
  subCategoryId   String            @map("sub_category_id")
  name            String
  description     String?
  price           Float
  currency        String            @default("USD")
  imageUrl        String?           @map("image_url")
  tags            String[]          @default([])
  allergens       String[]          @default([])
  availabilityStatus AvailabilityStatus @default(AVAILABLE) @map("availability_status")
  preparationTime Int?              @map("preparation_time") // in minutes
  nutritionalValues Json?           @map("nutritional_values") // Calories, protein, carbs, fat, etc.
  sortOrder       Int               @default(0) @map("sort_order")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")

  // Relations
  subCategory SubCategory @relation(fields: [subCategoryId], references: [id], onDelete: Cascade)

  @@map("menu_items")
}

enum AvailabilityStatus {
  AVAILABLE
  OUT_OF_STOCK
  SEASONAL
}

// Table model for QR codes
model Table {
  id              String   @id @default(cuid())
  restaurantId    String   @map("restaurant_id")
  tableNumber     String   @map("table_number")
  qrCodeData      String?  @map("qr_code_data")
  qrCodeUrlSvg    String?  @map("qr_code_url_svg")
  qrCodeUrlPng    String?  @map("qr_code_url_png")
  brandingSettings Json?   @map("branding_settings")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, tableNumber])
  @@map("tables")
}

// Dynamic Pricing model - time-based price adjustments
model DynamicPricing {
  id              String   @id @default(cuid())
  restaurantId    String   @map("restaurant_id")
  name            String
  description     String?
  daysOfWeek      Int[]    @default([]) @map("days_of_week") // 0 = Sunday, 6 = Saturday
  startTime       String   @map("start_time") // HH:mm format
  endTime         String   @map("end_time") // HH:mm format
  adjustmentType  PricingAdjustmentType @default(PERCENTAGE) @map("adjustment_type")
  adjustmentValue Float    @map("adjustment_value") // Percentage or fixed amount
  targetType      PricingTargetType @default(ALL) @map("target_type")
  targetIds       String[] @default([]) @map("target_ids") // Category, SubCategory, or MenuItem IDs
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("dynamic_pricing")
}

enum PricingAdjustmentType {
  PERCENTAGE
  FIXED
}

enum PricingTargetType {
  ALL
  CATEGORY
  SUBCATEGORY
  MENU_ITEM
}

// Offer model - promotional offers with time windows
model Offer {
  id              String   @id @default(cuid())
  restaurantId    String   @map("restaurant_id")
  name            String
  description     String?
  offerType       OfferType @default(DISCOUNT) @map("offer_type")
  discountValue   Float?    @map("discount_value") // Percentage or fixed amount
  targetType      OfferTargetType @default(ALL) @map("target_type")
  targetIds       String[] @default([]) @map("target_ids") // Category, SubCategory, or MenuItem IDs
  startDate       DateTime? @map("start_date")
  endDate         DateTime? @map("end_date")
  isForever       Boolean  @default(false) @map("is_forever")
  daysOfWeek      Int[]    @default([]) @map("days_of_week") // 0 = Sunday, 6 = Saturday
  startTime       String?  @map("start_time") // HH:mm format
  endTime         String?  @map("end_time") // HH:mm format
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("offers")
}

enum OfferType {
  DISCOUNT
  BUY_ONE_GET_ONE
  FIXED_PRICE
}

enum OfferTargetType {
  ALL
  CATEGORY
  SUBCATEGORY
  MENU_ITEM
}
